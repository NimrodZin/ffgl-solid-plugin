name: Build FFGL Plugin

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/windows
        # Search for the DLL
        Write-Host "Searching for SolidColor.dll..."
        Get-ChildItem -Path build -Recurse -Filter "SolidColor.dll" | ForEach-Object { Write-Host $_.FullName }
        Get-ChildItem -Path build -Recurse -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }
        # Try to copy from common locations
        $dllPath = Get-ChildItem -Path build -Recurse -Filter "SolidColor.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($dllPath) {
          Write-Host "Found DLL at: $($dllPath.FullName)"
          Copy-Item $dllPath.FullName artifacts/windows/
          # Also search for GLEW
          $glewPath = Get-ChildItem -Path build -Recurse -Filter "glew32.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($glewPath) {
            Copy-Item $glewPath.FullName artifacts/windows/
          }
        } else {
          Write-Host "ERROR: SolidColor.dll not found!"
          Write-Host "Build directory structure:"
          Get-ChildItem -Path build -Recurse | Select-Object FullName
          exit 1
        }
      shell: pwsh
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: SolidColor-Windows
        path: artifacts/windows/
        retention-days: 30

  build-macos:
    name: Build macOS (Universal)
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Configure CMake (Universal Binary)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
          -DCMAKE_OSX_DEPLOYMENT_TARGET="10.15"
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Verify Universal Binary
      run: |
        echo "Checking architecture of built plugin..."
        if [ -d "build/bin/SolidColor.bundle" ]; then
          lipo -archs build/bin/SolidColor.bundle/Contents/MacOS/SolidColor
        fi
    
    - name: Prepare artifacts
      run: |
        mkdir -p artifacts/macos
        if [ -d "build/bin/SolidColor.bundle" ]; then
          cp -R build/bin/SolidColor.bundle artifacts/macos/
        fi
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: SolidColor-macOS-Universal
        path: artifacts/macos/
        retention-days: 30

  # Create release when a tag is pushed
  release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create zip archives
      run: |
        cd artifacts
        zip -r SolidColor-Windows.zip SolidColor-Windows/
        zip -r SolidColor-macOS-Universal.zip SolidColor-macOS-Universal/
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/SolidColor-Windows.zip
          artifacts/SolidColor-macOS-Universal.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
